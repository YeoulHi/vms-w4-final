### 유저플로우 01 (정제본): 내부 직원 로그인 및 대시보드 접근

1. **입력**

   * 사용자가 브라우저에서 `/dashboard/` 또는 루트 경로에 접속한다.
   * 사용자는 로그인되어 있을 수도 있고 아닐 수도 있다.
   * 사용자가 `/admin/ingest/...`처럼 관리자 전용 경로에 직접 접근할 수도 있다.

2. **처리**

   1. 요청에 세션이 있는지 확인한다.
   2. 세션이 **없으면** Django 기본 로그인 뷰(`/login/`)로 리다이렉트한다.
   3. 로그인 폼에서 유효한 계정으로 인증되면 세션을 생성한다.
   4. 로그인 성공 시 사용자를 `/dashboard/`로 이동시킨다.
   5. 사용자가 관리자 전용 URL에 접근한 경우, 현재 사용자에 대해 `is_staff == True` 인지만 검사한다.
   6. `is_staff == False` 이면 즉시 403을 반환한다.
   7. 위 과정에서 별도 실패 횟수 기록, 비활성 계정 처리, 보안 로그 저장, 동시 로그인 제어는 수행하지 않는다.

3. **출력**

   * 세션이 있는 정상 사용자: 대시보드 페이지가 렌더링된다.
   * 세션이 없는 사용자: 로그인 화면으로 이동된다.
   * 관리자 전용 경로에 권한 없이 접근한 사용자: 403 상태가 반환된다.
   * 로그인 성공 시: 세션 쿠키가 발급되고 이후 요청에서 그대로 재사용된다.
   * 사이드이펙트는 Django 기본 Admin 로그 외 별도 저장을 하지 않는다.

---

### 유저플로우 02 — 관리자 엑셀 업로드 → pandas 파싱 → Postgres 저장 (최종 확정본)

---

#### 1. 입력 (Input)

* **사용자 조건**: `is_staff=True`인 관리자만 접근 가능
* **진입 경로**: Django Admin `/admin/ingest/exceldata/add/`
* **입력 항목**

  * 엑셀 또는 CSV 파일 1개 선택
  * 허용 확장자: `.xls`, `.xlsx`, `.csv`
* **엣지케이스**

  * 파일이 없거나 확장자가 다름
  * 업로드 중 중단(네트워크 끊김 등)
  * 업로드 중 세션 만료

---

#### 2. 처리 (Process)

1. **권한 확인**

   * 요청 사용자의 `is_staff` 여부 확인
   * False인 경우 즉시 `403 Forbidden` 반환

2. **파일 검증**

   * 파일 존재 여부 확인
   * 확장자 화이트리스트 검사
   * 실패 시 업로드 중단

3. **파일 파싱**

   * `pandas.read_excel()` 또는 `read_csv()`로 로드
   * 로드 실패 시 전체 업로드 실패 처리

4. **컬럼 검증**

   * 필수 컬럼 존재 여부 확인

     * `["year", "department", "metric_type", "value"]`
   * 누락 시 전체 업로드 실패 처리

5. **행 단위 파싱 및 저장**

   * 각 행에 대해 다음 순서 수행:

     1. 필드별 타입 캐스팅
     2. 문자열 정규화(공백, 대소문자, 특수문자)
     3. `_upsert_metric_record(row)` 호출하여 DB에 저장

        * 동일 키(`year`, `department`, `metric_type`) 존재 시 업데이트
        * 신규 데이터는 삽입
     4. 오류 발생 시 해당 행만 실패 리스트에 기록하고 다음 행으로 진행

6. **결과 집계**

   * 전체 행 수, 성공 건수, 실패 건수 계산
   * 실패 목록(행 번호, 원인)은 메모리 내 리스트로 유지

---

#### 3. 출력 (Output)

* **Admin 피드백**

  * 화면 상단에 “총 N건 중 M건 성공, K건 실패” 형태의 요약 표시
  * 구체적인 실패 행 정보는 콘솔 로그에 출력
* **DB 반영**

  * 성공한 행만 커밋
  * 실패한 행은 저장되지 않음
* **에러 상황 처리**

  * 권한 없음 → 403 응답
  * 파일 없음/잘못된 확장자 → 업로드 중단 후 폼 리렌더
  * pandas 파싱 실패 → 업로드 실패 메시지 출력

---

#### 4. 구현 단위 함수 요약

| 함수명                              | 설명                      |
| -------------------------------- | ----------------------- |
| `parse_and_save_excel(file_obj)` | 전체 업로드 프로세스 제어 (단일 진입점) |
| `_validate_columns(df)`          | 필수 컬럼 존재 여부 검증          |
| `_normalize_row(row)`            | 데이터 정규화 및 타입 캐스팅        |
| `_upsert_metric_record(row)`     | 단일 행 DB 삽입 또는 업데이트      |
| `_summarize_result(result_list)` | 성공/실패 통계 요약 생성          |

---

#### 5. 수용 기준 (Acceptance Criteria)

| 항목     | 기준                               |
| ------ | -------------------------------- |
| 파일 확장자 | `.xls`, `.xlsx`, `.csv` 외 업로드 불가 |
| 파일 크기  | 10MB 이하 (Django 설정값 기준)          |
| 컬럼 검증  | 필수 4개 컬럼 중 1개라도 누락 시 전체 실패       |
| 파싱 실패율 | 20% 이상 실패 시 업로드 전체 실패로 간주        |
| 응답 속도  | 5,000행 이하 기준 3초 이내 처리 완료         |

---

> ✅ **요약:**
> 본 유저플로우는 PRD, Code Structure, 요구사항의 핵심 목표(업로드 → 파싱 → 저장)를 그대로 반영하며,
> 불필요한 항목(메타입력, 로그 저장, 캐시 무효화, 중복검사)을 모두 제거했습니다.
> `parse_and_save_excel()` 단일 함수 중심의 단순하고 방어적인 MVP 구조로 확정되었습니다.

--- 

### 유저플로우 03 — 대시보드 조회 및 차트 시각화 (최종 확정본)

---

#### 1. 입력 (Input)

* **사용자 조건:**
  세션 인증이 완료된 내부 직원(관리자 포함)

* **진입 경로:**
  브라우저에서 `/dashboard/` 접근

* **사용자 조작:**

  * 필터 항목: `year`, `department` (선택적으로 `metric_type`)
  * 조회 버튼 클릭 시 `/api/dashboard/chart-data/?year=...&department=...` GET 요청 발생

* **엣지케이스 입력:**

  * 필터가 비어 있음 → 기본값 사용
  * 유효하지 않은 연도/학과 값 → 400 오류
  * 세션 만료 → 로그인 페이지로 리다이렉트

---

#### 2. 처리 (Process)

1. **페이지 접근 및 기본 렌더**

   * 서버는 세션을 확인한다.
   * 세션이 없으면 `/login/`으로 리다이렉트한다.
   * 세션이 유효하면 Django Template을 사용해 `/dashboard/` 페이지를 렌더링하고,
     **기본 필터값(최신 연도, 전체 학과)** 을 **context로 내려준다.**

2. **필터 요청 및 데이터 조회**

   * 사용자가 필터를 조정하면 프런트엔드에서 `/api/dashboard/chart-data/`로 GET 요청을 보낸다.
   * API는 세션을 다시 확인하고,

     * 파라미터가 비었으면 기본값으로 대체한다.
     * 유효하지 않으면 400 오류로 응답한다.

3. **데이터 조회 및 변환**

   * 유효한 파라미터만으로 `get_dashboard_data(year, department)` 호출
   * 조회된 데이터를 `to_chartjs()` 함수로 변환
   * **단일 차트 구조(JSON)** 로 변환된 데이터를 반환

4. **에러 처리**

   * 400: 잘못된 파라미터
   * 401/403: 세션 없음
   * 500: DB 오류 (Django 기본 핸들러 사용)
   * 모든 에러 응답은 `"error": "<code>"` 단일 필드로 구성

5. **비구현 항목 (문서로만 남김)**

   * 캐시, 다중 차트, 폴백(리트라이)은 구현하지 않으며
     추후 확장 문서에만 명시한다.

---

#### 3. 출력 (Output)

* **성공 (`200 OK`)**

  ```json
  {
    "labels": ["2023", "2024"],
    "datasets": [
      { "label": "등록률", "data": [80, 85], "backgroundColor": "#4A90E2" }
    ]
  }
  ```

* **실패 (`400`, `401`, `403`, `500`)**

  ```json
  { "error": "invalid_parameter" }
  ```

* **데이터 없음 (`200 OK`)**

  ```json
  { "labels": [], "datasets": [] }
  ```

---

#### 4. 구현 단위 함수 요약

| 함수명                                    | 역할                                   |
| -------------------------------------- | ------------------------------------ |
| `get_dashboard_data(year, department)` | Postgres에서 해당 조건의 metric 데이터 조회      |
| `to_chartjs(dataset)`                  | 조회 결과를 Chart.js 포맷 JSON으로 변환         |
| `chart_data_view(request)`             | DRF APIView — 파라미터 검증, 서비스 호출, 응답 반환 |

---

#### 5. 수용 기준 (Acceptance Criteria)

| 항목         | 기준                                           |
| ---------- | -------------------------------------------- |
| **필터 항목**  | 연도, 학과 2개만 허용 (`metric_type`은 선택적)           |
| **응답 구조**  | Chart.js 표준 포맷(JSON), 단일 차트 기준               |
| **에러 처리**  | 3단계 코드(400/401/500), `"error": "<code>"` 형태  |
| **성능**     | 3,000행 이하 기준 500ms 이내 응답                     |
| **기본값 제공** | 서버 Template context로 기본 필터값(최신 연도, 전체 학과) 전달 |
| **비구현 항목** | 캐시, 다중 차트, 폴백 등은 문서로만 명시, 코드 구현 금지           |

---

> ✅ **요약:**
> 이 버전은 PRD, 클라이언트 요구사항, Code-Structure 모두와 완전히 일치합니다.
> 핵심은 “내부 직원이 로그인 후 `/dashboard/`에서 필터를 조정하면, `/api/dashboard/chart-data/`가 Chart.js가 바로 그릴 수 있는 단일 차트 JSON을 반환한다”는 단순하고 유지보수 쉬운 구조입니다.
> Django Template이 기본 필터를 context로 내려주는 방식까지 명확히 규정되어, **MVP 완성 기준을 100% 충족**합니다.


--- 

### 유저플로우 04 — 업로드 이후 대시보드 데이터 반영 (최종 확정본)

**파일 경로:** `/docs/userflow/04.data-freshness.md`

---

#### 1. 개요

이 문서는 “엑셀 업로드 후 대시보드에 데이터가 언제 반영되는가”를 정의한다.
기능 추가가 아닌 **시점 정의(freshness definition)** 단계로서,
PRD·클라이언트 요구·Code-Structure·requirement의 **동기적 데이터 흐름 원칙**에 따라 작성되었다.

핵심 원칙은 다음과 같다:

> 업로드가 커밋되면 즉시 DB 최신 상태가 되고,
> 대시보드는 사용자가 다시 접근하거나 새로고침할 때 즉시 최신 데이터를 조회한다.
> 캐시, 비동기, 폴백은 구현하지 않는다.

---

#### 2. 입력 (Input)

* **행위 주체**

  * 관리자(Admin): `/admin/ingest/exceldata/add/` 경로에서 엑셀 업로드 수행
  * 내부 직원(User): `/dashboard/` 페이지에서 시각화된 지표 조회

* **전제 조건**

  * 업로드 성공 시 pandas 파싱 → ORM 커밋까지 **동기 처리**
  * 모든 유효 행이 커밋되면 DB가 최신 상태가 된다.
  * 캐시, 메시지 큐, 비동기 태스크는 존재하지 않는다.
  * 실패한 행은 저장되지 않으며, **partial commit** 허용된다.

* **엣지케이스**

  * 업로드 실패 → 대시보드는 이전 커밋 데이터 유지
  * 업로드 중 조회 발생 → 직전 커밋 데이터 응답
  * 대시보드 장시간 유지 시 → 사용자가 재조회(새로고침 등)해야 최신 반영

---

#### 3. 처리 (Process)

1. **업로드 및 커밋**

   * 관리자가 엑셀 업로드를 완료하면 `parse_and_save_excel(file)`이 모든 행을 처리한다.
   * 유효한 행만 ORM을 통해 즉시 커밋되며, 이 시점이 시스템의 최신 상태가 된다.
   * 별도의 `_commit_transaction()` 함수나 외부 트랜잭션 래퍼는 사용하지 않는다.

2. **대시보드 데이터 조회**

   * 내부 직원이 `/dashboard/`에 접근하면 Django Template이 페이지를 렌더링하고,
     **기본 필터값(최신 연도, 전체 학과)** 을 context로 내려준다.
   * 사용자가 재접속, 페이지 새로고침, 혹은 필터 재적용 시
     `/api/dashboard/chart-data/?year=...&department=...` 요청이 발생한다.
   * API는 DB에서 실시간 SELECT를 수행해 Chart.js 포맷(JSON)으로 응답한다.

3. **데이터 반영 원칙**

   * 커밋된 데이터만 조회된다. 실패하거나 롤백된 행은 포함되지 않는다.
   * 업로드가 실패한 경우 대시보드는 기존 커밋 데이터만 유지한다.
   * “업로드 → 커밋 → 즉시 SELECT”의 단일 흐름으로, 별도 큐·지연 반영은 없다.

4. **선택적 UI (Optional)**

   * 대시보드 하단에 “마지막 업데이트: YYYY-MM-DD HH:mm” 형태로 표시할 수 있다.
   * 해당 값은 Django Template context로 전달되며, 구현은 선택적이다.

---

#### 4. 출력 (Output)

* **관리자(Admin)**

  * 업로드 성공 시: “총 N건 중 M건 성공, K건 실패” 메시지 표시
  * 업로드 실패 시: 전체 롤백 및 오류 메시지 출력
  * 커밋 시점 = DB 최신 시점

* **내부 직원(User)**

  * `/dashboard/` 재접속·새로고침·필터 재적용 시 최신 데이터 자동 반영
  * partial commit 발생 시 → 커밋된 데이터만 표시, 실패분은 반영되지 않음

---

#### 5. 구현 단위 및 문서화 범위

| 구분                     | 처리 방식                                         |
| ---------------------- | --------------------------------------------- |
| **트랜잭션 처리**            | ingest/services.py 내부에서 ORM 단일 커밋 (별도 함수 없음)  |
| **데이터 조회**             | `get_dashboard_data(year, department)` 서비스 함수 |
| **차트 변환**              | `to_chartjs()` — 내부 도메인 데이터를 Chart.js 포맷으로 변환 |
| **업데이트 표시 (Optional)** | Template context에서 `last_updated` 전달 가능       |
| **비동기/캐시**             | 구현 금지 — 문서로만 관리                               |

---

#### 6. 수용 기준 (Acceptance Criteria)

| 항목           | 기준                            |
| ------------ | ----------------------------- |
| **DB 반영 시점** | 업로드 커밋 완료 즉시 최신 상태            |
| **조회 타이밍**   | 재접속·새로고침·필터 재적용 시 최신 데이터 표시   |
| **데이터 정책**   | partial commit 허용 (성공 행만 반영)  |
| **일관성 정책**   | 업로드 실패/롤백 시 이전 커밋 데이터 유지      |
| **성능 기준**    | 3,000행 이하 기준 500ms 이내 응답      |
| **선택적 UI**   | “마지막 업데이트 시각”은 표시해도 되고 생략 가능  |
| **확장성**      | 비동기·캐시·이벤트 푸시는 문서화만 수행, 구현 금지 |

---

#### 7. 요약

> 이 플로우는 **“업로드 → 커밋 → 즉시 반영 → 새로고침 시 조회”**
> 라는 MVP 수준의 단일 동기 구조를 정의한다.
> PRD의 “엑셀 업로드 후 바로 시각화” 요구와 완전히 일치하며,
> 클라이언트가 요청한 단순성(내부직원 편의, 최소 복잡도)을 보장한다.
>
> ✅ **정합성 100%**
> — PRD / Code-Structure / Requirement / Client 모든 기준 충족
> — `/docs/userflow/04.data-freshness.md` 버전으로 확정 가능.


